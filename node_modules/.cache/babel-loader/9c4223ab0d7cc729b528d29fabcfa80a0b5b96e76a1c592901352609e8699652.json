{"ast":null,"code":"import { OpenAIClient } from \"@langchain/openai\";\nimport { AsyncCaller } from \"@langchain/core/utils/async_caller\";\nimport { getEnvironmentVariable } from \"@langchain/core/utils/env\";\nimport { BaseChain } from \"./base.js\";\n/**\n * Class representing a chain for moderating text using the OpenAI\n * Moderation API. It extends the BaseChain class and implements the\n * OpenAIModerationChainInput interface.\n * @example\n * ```typescript\n * const moderation = new OpenAIModerationChain({ throwError: true });\n *\n * const badString = \"Bad naughty words from user\";\n *\n * try {\n *   const { output: moderatedContent, results } = await moderation.call({\n *     input: badString,\n *   });\n *\n *   if (results[0].category_scores[\"harassment/threatening\"] > 0.01) {\n *     throw new Error(\"Harassment detected!\");\n *   }\n *\n *   const model = new OpenAI({ temperature: 0 });\n *   const promptTemplate = \"Hello, how are you today {person}?\";\n *   const prompt = new PromptTemplate({\n *     template: promptTemplate,\n *     inputVariables: [\"person\"],\n *   });\n *   const chain = new LLMChain({ llm: model, prompt });\n *   const response = await chain.call({ person: moderatedContent });\n *   console.log({ response });\n * } catch (error) {\n *   console.error(\"Naughty words detected!\");\n * }\n * ```\n */\nexport class OpenAIModerationChain extends BaseChain {\n  static lc_name() {\n    return \"OpenAIModerationChain\";\n  }\n  get lc_secrets() {\n    return {\n      openAIApiKey: \"OPENAI_API_KEY\"\n    };\n  }\n  constructor(fields) {\n    super(fields);\n    Object.defineProperty(this, \"inputKey\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: \"input\"\n    });\n    Object.defineProperty(this, \"outputKey\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: \"output\"\n    });\n    Object.defineProperty(this, \"openAIApiKey\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"openAIOrganization\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"clientConfig\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"client\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"throwError\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"caller\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    this.throwError = fields?.throwError ?? false;\n    this.openAIApiKey = fields?.apiKey ?? fields?.openAIApiKey ?? getEnvironmentVariable(\"OPENAI_API_KEY\");\n    if (!this.openAIApiKey) {\n      throw new Error(\"OpenAI API key not found\");\n    }\n    this.openAIOrganization = fields?.openAIOrganization;\n    this.clientConfig = {\n      ...fields?.configuration,\n      apiKey: this.openAIApiKey,\n      organization: this.openAIOrganization\n    };\n    this.client = new OpenAIClient(this.clientConfig);\n    this.caller = new AsyncCaller(fields ?? {});\n  }\n  _moderate(text, results) {\n    if (results.flagged) {\n      const errorStr = \"Text was found that violates OpenAI's content policy.\";\n      if (this.throwError) {\n        throw new Error(errorStr);\n      } else {\n        return errorStr;\n      }\n    }\n    return text;\n  }\n  async _call(values) {\n    const text = values[this.inputKey];\n    const moderationRequest = {\n      input: text\n    };\n    let mod;\n    try {\n      mod = await this.caller.call(() => this.client.moderations.create(moderationRequest));\n    } catch (error) {\n      // eslint-disable-next-line no-instanceof/no-instanceof\n      if (error instanceof Error) {\n        throw error;\n      } else {\n        throw new Error(error);\n      }\n    }\n    const output = this._moderate(text, mod.results[0]);\n    return {\n      [this.outputKey]: output,\n      results: mod.results\n    };\n  }\n  _chainType() {\n    return \"moderation_chain\";\n  }\n  get inputKeys() {\n    return [this.inputKey];\n  }\n  get outputKeys() {\n    return [this.outputKey];\n  }\n}","map":{"version":3,"names":["OpenAIClient","AsyncCaller","getEnvironmentVariable","BaseChain","OpenAIModerationChain","lc_name","lc_secrets","openAIApiKey","constructor","fields","Object","defineProperty","enumerable","configurable","writable","value","throwError","apiKey","Error","openAIOrganization","clientConfig","configuration","organization","client","caller","_moderate","text","results","flagged","errorStr","_call","values","inputKey","moderationRequest","input","mod","call","moderations","create","error","output","outputKey","_chainType","inputKeys","outputKeys"],"sources":["/Users/youngchen/Downloads/cs224g-triage/node_modules/langchain/dist/chains/openai_moderation.js"],"sourcesContent":["import { OpenAIClient } from \"@langchain/openai\";\nimport { AsyncCaller, } from \"@langchain/core/utils/async_caller\";\nimport { getEnvironmentVariable } from \"@langchain/core/utils/env\";\nimport { BaseChain } from \"./base.js\";\n/**\n * Class representing a chain for moderating text using the OpenAI\n * Moderation API. It extends the BaseChain class and implements the\n * OpenAIModerationChainInput interface.\n * @example\n * ```typescript\n * const moderation = new OpenAIModerationChain({ throwError: true });\n *\n * const badString = \"Bad naughty words from user\";\n *\n * try {\n *   const { output: moderatedContent, results } = await moderation.call({\n *     input: badString,\n *   });\n *\n *   if (results[0].category_scores[\"harassment/threatening\"] > 0.01) {\n *     throw new Error(\"Harassment detected!\");\n *   }\n *\n *   const model = new OpenAI({ temperature: 0 });\n *   const promptTemplate = \"Hello, how are you today {person}?\";\n *   const prompt = new PromptTemplate({\n *     template: promptTemplate,\n *     inputVariables: [\"person\"],\n *   });\n *   const chain = new LLMChain({ llm: model, prompt });\n *   const response = await chain.call({ person: moderatedContent });\n *   console.log({ response });\n * } catch (error) {\n *   console.error(\"Naughty words detected!\");\n * }\n * ```\n */\nexport class OpenAIModerationChain extends BaseChain {\n    static lc_name() {\n        return \"OpenAIModerationChain\";\n    }\n    get lc_secrets() {\n        return {\n            openAIApiKey: \"OPENAI_API_KEY\",\n        };\n    }\n    constructor(fields) {\n        super(fields);\n        Object.defineProperty(this, \"inputKey\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: \"input\"\n        });\n        Object.defineProperty(this, \"outputKey\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: \"output\"\n        });\n        Object.defineProperty(this, \"openAIApiKey\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"openAIOrganization\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"clientConfig\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"client\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"throwError\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        Object.defineProperty(this, \"caller\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        this.throwError = fields?.throwError ?? false;\n        this.openAIApiKey =\n            fields?.apiKey ??\n                fields?.openAIApiKey ??\n                getEnvironmentVariable(\"OPENAI_API_KEY\");\n        if (!this.openAIApiKey) {\n            throw new Error(\"OpenAI API key not found\");\n        }\n        this.openAIOrganization = fields?.openAIOrganization;\n        this.clientConfig = {\n            ...fields?.configuration,\n            apiKey: this.openAIApiKey,\n            organization: this.openAIOrganization,\n        };\n        this.client = new OpenAIClient(this.clientConfig);\n        this.caller = new AsyncCaller(fields ?? {});\n    }\n    _moderate(text, results) {\n        if (results.flagged) {\n            const errorStr = \"Text was found that violates OpenAI's content policy.\";\n            if (this.throwError) {\n                throw new Error(errorStr);\n            }\n            else {\n                return errorStr;\n            }\n        }\n        return text;\n    }\n    async _call(values) {\n        const text = values[this.inputKey];\n        const moderationRequest = {\n            input: text,\n        };\n        let mod;\n        try {\n            mod = await this.caller.call(() => this.client.moderations.create(moderationRequest));\n        }\n        catch (error) {\n            // eslint-disable-next-line no-instanceof/no-instanceof\n            if (error instanceof Error) {\n                throw error;\n            }\n            else {\n                throw new Error(error);\n            }\n        }\n        const output = this._moderate(text, mod.results[0]);\n        return {\n            [this.outputKey]: output,\n            results: mod.results,\n        };\n    }\n    _chainType() {\n        return \"moderation_chain\";\n    }\n    get inputKeys() {\n        return [this.inputKey];\n    }\n    get outputKeys() {\n        return [this.outputKey];\n    }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}